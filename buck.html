import React, { useState, useRef, useEffect } from 'react';
import { Heart, MessageCircle, Send, User, Home, PlusSquare, Film, Check, Users, Trash2, Bookmark } from 'lucide-react';

const BuckApp = () => {
  const [currentView, setCurrentView] = useState('home');
  const [currentUser, setCurrentUser] = useState(null);
  const [allPosts, setAllPosts] = useState([]);
  const [allUsers, setAllUsers] = useState([]);
  const [following, setFollowing] = useState(new Set());
  const [savedPosts, setSavedPosts] = useState(new Set());
  const fileInputRef = useRef(null);
  const [newComment, setNewComment] = useState({});

  const SUPABASE_URL = 'https://vmwqfzzrtvslpsrlhzzo.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZtd3FmenpydHZzbHBzcmxoenpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NTI5OTgsImV4cCI6MjA4MzIyODk5OH0.0Zv5GbVyBBvPYvEnKLvDm7mxPFG_ACwoUPXvwa9-09o';

  useEffect(() => {
    initUser();
    const interval = setInterval(loadData, 5000);
    return () => clearInterval(interval);
  }, []);

  const initUser = async () => {
    try {
      let userId = localStorage.getItem('buck_user_id');
      
      if (userId) {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`
          }
        });
        const data = await response.json();
        if (data && data.length > 0) {
          setCurrentUser(data[0]);
        } else {
          await createNewUser();
        }
      } else {
        await createNewUser();
      }

      const savedFollowing = localStorage.getItem('buck_following');
      if (savedFollowing) setFollowing(new Set(JSON.parse(savedFollowing)));

      const savedPostsData = localStorage.getItem('buck_saved');
      if (savedPostsData) setSavedPosts(new Set(JSON.parse(savedPostsData)));

      loadData();
    } catch (error) {
      console.error('Error initializing user:', error);
      createFallbackUser();
    }
  };

  const createFallbackUser = () => {
    const fallbackUser = {
      id: 'user_' + Date.now(),
      name: 'User' + Math.floor(Math.random() * 9999),
      username: 'user' + Math.floor(Math.random() * 999999),
      followers: 0,
      following: 0,
      bio: 'ðŸŒŸ New to Buck!',
      avatar: 'ðŸ˜Š',
      profile_color: '#3b82f6',
      created_at: Date.now()
    };
    setCurrentUser(fallbackUser);
  };

  const createNewUser = async () => {
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const avatars = ['ðŸ˜Š', 'ðŸŽ¨', 'ðŸš€', 'â­', 'ðŸŒˆ', 'ðŸŽµ'];
    const newUser = {
      id: userId,
      name: 'User' + Math.floor(Math.random() * 9999),
      username: 'user' + Math.floor(Math.random() * 999999),
      followers: 0,
      following: 0,
      bio: 'ðŸŒŸ New to Buck!',
      avatar: avatars[Math.floor(Math.random() * 6)],
      profile_color: '#' + Math.floor(Math.random()*16777215).toString(16),
      created_at: Date.now()
    };

    try {
      await fetch(`${SUPABASE_URL}/rest/v1/users`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(newUser)
      });
      localStorage.setItem('buck_user_id', userId);
      setCurrentUser(newUser);
    } catch (error) {
      console.error('Error creating user:', error);
      setCurrentUser(newUser);
    }
  };

  const loadData = async () => {
    try {
      const postsResponse = await fetch(`${SUPABASE_URL}/rest/v1/posts?order=timestamp.desc`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      const postsData = await postsResponse.json();
      if (postsData) setAllPosts(postsData);

      const usersResponse = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      const usersData = await usersResponse.json();
      if (usersData) setAllUsers(usersData);
    } catch (error) {
      console.error('Error loading data:', error);
    }
  };

  const handleFileUpload = async (e) => {
    if (!currentUser) return;
    
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
      const post = {
        id: 'post_' + Date.now() + '_' + currentUser.id,
        user_id: currentUser.id,
        type: file.type.startsWith('video') ? 'video' : 'image',
        content: event.target.result,
        caption: 'Check out my new post! âœ¨',
        likes: 0,
        liked_by: [],
        comments: [],
        timestamp: Date.now()
      };
      
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/posts`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(post)
        });
        setCurrentView('home');
        await loadData();
      } catch (error) {
        console.error('Error uploading post:', error);
      }
    };
    reader.readAsDataURL(file);
  };

  const handleLike = async (post) => {
    if (!currentUser) return;

    const likedBy = post.liked_by || [];
    const hasLiked = likedBy.includes(currentUser.id);
    
    const updatedPost = {
      likes: hasLiked ? post.likes - 1 : post.likes + 1,
      liked_by: hasLiked 
        ? likedBy.filter(id => id !== currentUser.id)
        : [...likedBy, currentUser.id]
    };

    try {
      await fetch(`${SUPABASE_URL}/rest/v1/posts?id=eq.${post.id}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(updatedPost)
      });
      await loadData();
    } catch (error) {
      console.error('Error liking post:', error);
    }
  };

  const deletePost = async (postId) => {
    if (!currentUser || !confirm('Delete this post?')) return;

    try {
      await fetch(`${SUPABASE_URL}/rest/v1/posts?id=eq.${postId}`, {
        method: 'DELETE',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      await loadData();
    } catch (error) {
      console.error('Error deleting post:', error);
    }
  };

  const addComment = async (post, commentText) => {
    if (!currentUser || !commentText.trim()) return;

    const updatedPost = {
      comments: [
        ...post.comments,
        {
          userId: currentUser.id,
          username: currentUser.username,
          text: commentText,
          timestamp: Date.now()
        }
      ]
    };

    try {
      await fetch(`${SUPABASE_URL}/rest/v1/posts?id=eq.${post.id}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(updatedPost)
      });
      setNewComment({ ...newComment, [post.id]: '' });
      await loadData();
    } catch (error) {
      console.error('Error adding comment:', error);
    }
  };

  const handleFollow = async (userId) => {
    if (!currentUser || userId === currentUser.id) return;

    const newFollowing = new Set(following);
    const isFollowing = newFollowing.has(userId);

    if (isFollowing) {
      newFollowing.delete(userId);
    } else {
      newFollowing.add(userId);
    }

    try {
      localStorage.setItem('buck_following', JSON.stringify([...newFollowing]));
      setFollowing(newFollowing);

      const targetUser = allUsers.find(u => u.id === userId);
      if (targetUser) {
        await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            followers: isFollowing ? targetUser.followers - 1 : targetUser.followers + 1
          })
        });
      }

      await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${currentUser.id}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({
          following: isFollowing ? currentUser.following - 1 : currentUser.following + 1
        })
      });

      await loadData();
    } catch (error) {
      console.error('Error following user:', error);
    }
  };

  const updateProfile = async (updates) => {
    if (!currentUser) return;

    const updatedUser = { ...currentUser, ...updates };
    setCurrentUser(updatedUser);

    try {
      await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${currentUser.id}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(updates)
      });
      await loadData();
    } catch (error) {
      console.error('Error updating profile:', error);
    }
  };

  const toggleSavePost = (postId) => {
    const newSaved = new Set(savedPosts);
    if (newSaved.has(postId)) {
      newSaved.delete(postId);
    } else {
      newSaved.add(postId);
    }
    setSavedPosts(newSaved);
    localStorage.setItem('buck_saved', JSON.stringify([...newSaved]));
  };

  const getTimeAgo = (timestamp) => {
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return `${Math.floor(seconds / 86400)}d ago`;
  };

  const HomeView = () => (
    <div className="space-y-4">
      <div className="bg-white rounded-xl shadow-md p-4 mb-4">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm text-gray-600">Real users online</p>
            <p className="text-2xl font-bold text-purple-600">{allUsers.length}</p>
          </div>
          <Users className="w-8 h-8 text-purple-600" />
        </div>
      </div>

      {allPosts.length === 0 ? (
        <div className="bg-white rounded-xl shadow-md p-8 text-center">
          <p className="text-gray-500 mb-4">No posts yet! Be the first to post.</p>
          <button 
            onClick={() => fileInputRef.current?.click()}
            className="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-semibold"
          >
            Create First Post
          </button>
        </div>
      ) : (
        allPosts.map(post => {
          const postUser = allUsers.find(u => u.id === post.user_id) || currentUser;
          if (!postUser) return null;

          return (
            <div key={post.id} className="bg-white rounded-xl shadow-md overflow-hidden">
              <div className="p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div 
                    className="w-10 h-10 rounded-full flex items-center justify-center text-2xl"
                    style={{ backgroundColor: postUser.profile_color }}
                  >
                    {postUser.avatar}
                  </div>
                  <div>
                    <div className="flex items-center gap-1">
                      <span className="font-semibold">{postUser.name}</span>
                      {postUser.followers >= 100000 && (
                        <div className="bg-blue-500 rounded-full p-0.5">
                          <Check className="w-3 h-3 text-white" />
                        </div>
                      )}
                    </div>
                    <span className="text-sm text-gray-500">@{postUser.username} â€¢ {getTimeAgo(post.timestamp)}</span>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {currentUser && post.user_id === currentUser.id && (
                    <button
                      onClick={() => deletePost(post.id)}
                      className="p-2 hover:bg-red-100 rounded-lg transition-colors"
                    >
                      <Trash2 className="w-5 h-5 text-red-600" />
                    </button>
                  )}
                  {currentUser && post.user_id !== currentUser.id && (
                    <button
                      onClick={() => handleFollow(post.user_id)}
                      className={`px-4 py-1 rounded-full text-sm font-semibold ${
                        following.has(post.user_id)
                          ? 'bg-gray-200 text-gray-700'
                          : 'bg-purple-600 text-white'
                      }`}
                    >
                      {following.has(post.user_id) ? 'Following' : 'Follow'}
                    </button>
                  )}
                </div>
              </div>
              
              {post.type === 'image' ? (
                <img src={post.content} alt="Post" className="w-full h-96 object-cover" />
              ) : (
                <div className="w-full h-96 bg-black">
                  <video 
                    src={post.content} 
                    controls 
                    className="w-full h-full object-contain"
                    preload="metadata"
                  />
                </div>
              )}
              
              <div className="p-4">
                <div className="flex items-center gap-4 mb-3">
                  <button 
                    onClick={() => handleLike(post)}
                    className="flex items-center gap-2 hover:scale-110 transition-transform"
                  >
                    <Heart 
                      className={`w-6 h-6 ${
                        currentUser && post.liked_by?.includes(currentUser.id)
                          ? 'fill-red-500 text-red-500'
                          : 'text-gray-700'
                      }`}
                    />
                    <span className="font-semibold">{post.likes}</span>
                  </button>
                  <div className="flex items-center gap-2">
                    <MessageCircle className="w-6 h-6 text-gray-700" />
                    <span className="font-semibold">{post.comments.length}</span>
                  </div>
                  <button className="ml-auto hover:scale-110 transition-transform" onClick={() => toggleSavePost(post.id)}>
                    <Bookmark 
                      className={`w-6 h-6 ${
                        savedPosts.has(post.id)
                          ? 'fill-purple-600 text-purple-600'
                          : 'text-gray-700'
                      }`}
                    />
                  </button>
                </div>
                
                <p className="mb-2"><span className="font-semibold">@{postUser.username}</span> {post.caption}</p>
                
                {post.comments.length > 0 && (
                  <div className="space-y-1 text-sm mb-2">
                    {post.comments.map((comment, idx) => (
                      <p key={idx}><span className="font-semibold">@{comment.username}</span> {comment.text}</p>
                    ))}
                  </div>
                )}
                
                <input
                  type="text"
                  placeholder="Add a comment..."
                  value={newComment[post.id] || ''}
                  onChange={(e) => setNewComment({ ...newComment, [post.id]: e.target.value })}
                  className="w-full mt-2 p-2 border rounded-lg text-sm"
                  onKeyPress={(e) => {
                    if (e.key === 'Enter') {
                      addComment(post, newComment[post.id]);
                    }
                  }}
                />
              </div>
            </div>
          );
        })
      )}
    </div>
  );

  const ProfileView = () => {
    if (!currentUser) return <div className="bg-white rounded-xl shadow-md p-6">Loading...</div>;

    const myPosts = allPosts.filter(p => p.user_id === currentUser.id);
    const mySavedPosts = allPosts.filter(p => savedPosts.has(p.id));

    return (
      <div className="space-y-4">
        <div className="bg-white rounded-xl shadow-md p-6">
          <div className="flex items-start gap-6 mb-6">
            <div 
              className="w-24 h-24 rounded-full flex items-center justify-center text-5xl"
              style={{ backgroundColor: currentUser.profile_color }}
            >
              {currentUser.avatar}
            </div>
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-2">
                <h2 className="text-2xl font-bold">{currentUser.name}</h2>
                {currentUser.followers >= 100000 && (
                  <div className="bg-blue-500 rounded-full p-1">
                    <Check className="w-4 h-4 text-white" />
                  </div>
                )}
              </div>
              <p className="text-gray-600 mb-3">@{currentUser.username}</p>
              <div className="flex gap-6 mb-3">
                <div><span className="font-bold">{myPosts.length}</span> posts</div>
                <div><span className="font-bold">{currentUser.followers}</span> followers</div>
                <div><span className="font-bold">{currentUser.following}</span> following</div>
              </div>
              <p className="text-gray-700">{currentUser.bio}</p>
            </div>
          </div>
          
          <div className="border-t pt-6">
            <h3 className="font-bold text-lg mb-4">Customize Profile</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2">Display Name</label>
                <input
                  type="text"
                  value={currentUser.name}
                  onChange={(e) => updateProfile({ name: e.target.value })}
                  className="w-full p-2 border rounded-lg"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Bio</label>
                <textarea
                  value={currentUser.bio}
                  onChange={(e) => updateProfile({ bio: e.target.value })}
                  className="w-full p-2 border rounded-lg"
                  rows="3"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Avatar Emoji</label>
                <input
                  type="text"
                  value={currentUser.avatar}
                  onChange={(e) => updateProfile({ avatar: e.target.value })}
                  className="w-full p-2 border rounded-lg text-2xl"
                  maxLength="2"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Profile Color</label>
                <input
                  type="color"
                  value={currentUser.profile_color}
                  onChange={(e) => updateProfile({ profile_color: e.target.value })}
                  className="w-full h-12 border rounded-lg cursor-pointer"
                />
              </div>
            </div>
          </div>
        </div>

        {mySavedPosts.length > 0 && (
          <div className="bg-white rounded-xl shadow-md p-6">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
              <Bookmark className="w-5 h-5" />
              Saved Posts ({mySavedPosts.length})
            </h3>
            <div className="grid grid-cols-3 gap-2">
              {mySavedPosts.slice(0, 6).map(post => (
                <div key={post.id} className="aspect-square rounded-lg overflow-hidden">
                  {post.type === 'image' ? (
                    <img src={post.content} alt="Saved" className="w-full h-full object-cover" />
                  ) : (
                    <video src={post.content} className="w-full h-full object-cover" />
                  )}
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    );
  };

  if (!currentUser) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-4">
            Buck
          </h1>
          <p className="text-gray-600">Setting up your account...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50">
      <div className="max-w-2xl mx-auto p-4">
        <header className="bg-white rounded-xl shadow-md p-4 mb-4 sticky top-4 z-10">
          <h1 className="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
            Buck
          </h1>
          <p className="text-sm text-gray-600 mt-1">Real-time multiplayer â€¢ {allUsers.length} users online</p>
        </header>

        <div className="mb-20">
          {currentView === 'home' && <HomeView />}
          {currentView === 'profile' && <ProfileView />}
        </div>

        <nav className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg">
          <div className="max-w-2xl mx-auto flex justify-around items-center p-4">
            <button 
              onClick={() => setCurrentView('home')}
              className={`p-2 rounded-lg ${currentView === 'home' ? 'bg-purple-100' : ''}`}
            >
              <Home className={`w-6 h-6 ${currentView === 'home' ? 'text-purple-600' : 'text-gray-600'}`} />
            </button>
            <button 
              onClick={() => fileInputRef.current?.click()}
              className="p-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full shadow-lg"
            >
              <PlusSquare className="w-6 h-6 text-white" />
            </button>
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*,video/*"
              onChange={handleFileUpload}
              className="hidden"
            />
            <button 
              onClick={() => setCurrentView('profile')}
              className={`p-2 rounded-lg ${currentView === 'profile' ? 'bg-purple-100' : ''}`}
            >
              <User className={`w-6 h-6 ${currentView === 'profile' ? 'text-purple-600' : 'text-gray-600'}`} />
            </button>
          </div>
        </nav>
      </div>
    </div>
  );
};

export default BuckApp;